\documentclass[14pt,russian,a4paper]{extarticle}

\usepackage[a4paper,left=30mm,right=15mm,top=20mm,bottom=20mm,bindingoffset=0cm]{geometry}
\usepackage{amsfonts,amssymb,amsmath,enumerate,float}
\usepackage{cmap}
\usepackage{ifthen}
\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}

\usepackage{graphicx}
\usepackage[font=small,labelfont=bf]{caption}
\usepackage{hyperref}
\usepackage{titlesec}


\linespread{1.5}

\renewcommand{\labelitemi}{$\bullet$}
\renewcommand{\labelitemii}{$\circ$}
\renewcommand{\labelitemiii}{$\diamond$}

\titleclass{\subsubsubsection}{straight}[\subsection]

\newcounter{subsubsubsection}[subsubsection]
\renewcommand\thesubsubsubsection{\thesubsubsection.\arabic{subsubsubsection}}
\renewcommand\theparagraph{\thesubsubsubsection.\arabic{paragraph}} % optional; useful if paragraphs are to be numbered

\titleformat{\subsubsubsection}
  {\normalfont\normalsize\bfseries}{\thesubsubsubsection}{1em}{}
\titlespacing*{\subsubsubsection}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\makeatletter
\renewcommand\paragraph{\@startsection{paragraph}{5}{\z@}%
  {3.25ex \@plus1ex \@minus.2ex}%
  {-1em}%
  {\normalfont\normalsize\bfseries}}
\renewcommand\subparagraph{\@startsection{subparagraph}{6}{\parindent}%
  {3.25ex \@plus1ex \@minus .2ex}%
  {-1em}%
  {\normalfont\normalsize\bfseries}}
\def\toclevel@subsubsubsection{4}
\def\toclevel@paragraph{5}
\def\toclevel@paragraph{6}
\def\l@subsubsubsection{\@dottedtocline{4}{7em}{4em}}
\def\l@paragraph{\@dottedtocline{5}{10em}{5em}}
\def\l@subparagraph{\@dottedtocline{6}{14em}{6em}}
\makeatother

\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}


\begin{document}

\thispagestyle{empty}

{\footnotesize 

\begin{center}
    МИНИСТЕРСТВО ОБРАЗОВАНИЯ И НАУКИ РОССИЙСКОЙ ФЕДЕРАЦИИ \\
    ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ АВТОНОМНОЕ ОБРАЗОВАТЕЛЬНОЕ \\
    УЧРЕЖДЕНИЕ ВЫСШЕГО ОБРАЗОВАНИЯ \\
    \guillemotleft НОВОСИБИРСКИЙ НАЦИОНАЛЬНЫЙ ИССЛЕДОВАТЕЛЬСКИЙ ГОСУДАРСТВЕННЫЙ \\
    УНИВЕРСИТЕТ\guillemotright (НОВОСИБИРСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ, НГУ)
\end{center}

\vspace{4mm}

\begin{flushleft}
    Факультет {\bf ФИЗИЧЕСКИЙ} \\
    Кафедра {\bf ФИЗИКО-ТЕХНИЧЕСКОЙ ИНФОРМАТИКИ}
\end{flushleft}
\begin{flushleft}
    Направление подготовки {\bf 03.04.02 ФИЗИКА} \\
    Образовательная программа {\bf МАГИСТРАТУРА}
\end{flushleft}

\vspace{4mm}


\begin{center}
    {\bf
    ВЫПУСКНАЯ КВАЛИФИКАЦИОННАЯ РАБОТА \\
    МАГИСТЕРСКАЯ ДИССЕРТАЦИЯ
    }
\end{center}

\begin{center}
    {\bf Герасёв Алексей Владимирович}
\end{center}

\begin{center}
    Тема работы: {\bf Разработка системы управления быстрыми компонентами электронно-лучевой установки}
\end{center}

\vspace{4mm}

\leftline{\bf \guillemotleft К защите допущена\guillemotright}

\vspace{2mm}

\noindent
\begin{minipage}[t]{70mm}
    \begin{center}
    {\bf Заведующий кафедрой} \\
    учёная степень, звание \\
    должность, место работы \\
    Логашенко И. Б. / \makebox[20mm]{\dotfill} \\
    \guillemotleft\makebox[10mm]{\dotfill}\guillemotright \makebox[30mm]{\dotfill} 20\makebox[5mm]{\dotfill} г.
    \end{center}
\end{minipage}
\hfill
\begin{minipage}[t]{70mm}
    \begin{center}
    {\bf Научный руководитель} \\
    учёная степень, звание \\
    должность, место работы \\
    Болховитянов Д. Ю. / \makebox[20mm]{\dotfill} \\
    \guillemotleft\makebox[10mm]{\dotfill}\guillemotright \makebox[30mm]{\dotfill} 20\makebox[5mm]{\dotfill} г. \\
    учёная степень, звание \\
    должность, место работы \\
    Чеблаков П. Б. / \makebox[20mm]{\dotfill} \\
    \guillemotleft\makebox[10mm]{\dotfill}\guillemotright \makebox[30mm]{\dotfill} 20\makebox[5mm]{\dotfill} г.
    \end{center}
\end{minipage}

\vspace{4mm}

\begin{flushright}
    Дата защиты: \guillemotleft\makebox[10mm]{\dotfill}\guillemotright \makebox[30mm]{\dotfill} 20\makebox[5mm]{\dotfill} г.
\end{flushright}

\vfill

\centerline{Новосибирск, 2018}
}

\newpage
\thispagestyle{empty}
\tableofcontents
\newpage

\section{Введение}

\subsection{Электронно-лучевые технологии}
В последнее время электронно-лучевые технологии всё шире используются в науке и промышленности. Принцип работы основан на том, что мощный пучок электронов попадает на материал объекта, помещённого в вакуум, и локально нагревает его до высоких температур. Данный подход используется для точной резки и сварки металлов, в том числе химически активных, тугоплавких и разнородных. Так как есть возможность получить достаточно узкий пучок высокой мощности, данная технология позволяет добиться высокой точности обработки материала. Также с недавнего времени широкое развитие получают такие направления электронно-лучевых технологий как аддитивные (к которым относится трёхмерная печать) и ионно-плазменные.

\subsection{Электронно-лучевые установки в ИЯФ}
В настоящее время в Институте Ядерной Физики СО РАН ведутся работы по развитию электронно-лучевых технологий \cite{weld_coord}. В ИЯФ СО РАН были разработаны, собраны и запущены несколько электронно-лучевых установок. Одна из этих установок (так называемая "малая" установка) является экспериментальной и используется для разработки и изучения новых электронно-лучевых технологий. При разработке малой установки был применён ряд уникальных технических решений (например, альфа-магнит \cite{alpha_magnet} и лазерный подогрев катода \cite{laser_heat}), а также проведён ряд уникальных экспериментов (3D-печать вольфрамом \cite{wolfram_3d} и т.д.).

\section{Малая электронно-лучевая установка}
Данная работа проводится для малой электронно-лучевой установки, поэтому рассмотрим эту установку подробнее.

\subsection{Описание}
Малая электронно-лучевая установка состоит из электронно-оптической колонны с альфа-магнитом \cite{alpha_magnet}, присоединённой к вакуумной камере, куда помещаются объекты, подвергаемые воздействию электронного пучка. Электронный пучок может иметь энергию электронов в диапазоне от 60 кэВ до 150 кэВ при мощности пучка от единиц до нескольких десятков киловатт. \cite{facility_desc} Минимальная ширина пучка при этом составляет около 0.1 мм.
\begin{figure}[h!]
    \centerline{\includegraphics[width=300pt]{media/alpha_scheme.jpeg}}
    \caption{Основные блоки малой электронно-лучевой установки}
    \label{fig:facility}
\end{figure}
\newline
Компоненты установки изображены на рисунке рис. \ref{fig:facility}. Электронная пушка испускает пучок электронов, который проходит через систему магнитной оптики, включающей в себя магнитное зеркало, также называемое альфа-магнитом, магнитные линзы и стигматоры, после чего попадает в технологический объём, где находится объект, подвергаемый воздействию электронного пучка. На данной установке реализована система дифференциальной откачки, что означает, что электронно-оптическая часть установки и технологический объём, сообщаются узким отверстием, которого достаточно только для прохождения узкого электронного пучка, а также каждый имеет собственную систему вакуумных насосов. Сделано это по причине того, что в технологическом объёме происходит активное испарение нагреваемого материала, который потом осаждается на стенки вакуумной камеры, поэтому чтобы как можно сильнее снизить загрязнение чувствительного оборудования и выполнены вышеописанные модификации. Электронная пушка также имеет ещё и собственный турбомолекулярный насос, так как для генерации пучка нужен более высокий вакуум. Альфа-магнит, поворачивающий электронный пучок на 270 градусов, также помогает снизить степень загрязнения источника электронов, так как позволяет переместить его в сторону от выхода из технологического объёма. Также, тот факт, что электронная пушка теперь направлена не в сторону технологического объёма, в будущем может позволить реализовать лазерный подогрев источника электронов, разместив источник лазерного излучения напротив электронной пушки.

\subsection{Модуль управления и контроля}
Модуль управления и контроля находится рядом с установкой, выполнен в виде шкафа в конструктиве "Вишня". В шкафу два верхних этажа занимает модуль УБС (устройство блокировок и сигнализаций), который обеспечивает таймирование управления модуляцией величины тока пучка, измерение токооседания и контроль вакуума. Следующие два этажа занимает модуль питания и контроля катушек магнитной фокусировки и отклонения пучка. Он включает в себя блоки компьютерного управления и контроля восьми каналов питания катушек – прецизионный аналого-цифровой контроллер CAC208 \cite{kozak_cac208}, общение с которыми осуществляется по шине CAN \cite{can}. В этом же шкафу размещается блок оптических связей OSF1, превращающий электрические сигналы в оптические (и обратно) для связи с контроллером прикатодной электроники (такое преобразование необходимо по причине того, что электроника в голове колонны находится под потенциалом -60 кВ). К OSF1 подключена шина CAN, также на него подаются сигналы включения/выключения и модуляции пучка, которые генерируются устройствами, также управляемыми по шине CAN.
\subsubsection{Медленные подсистемы}
Большинство подсистем данной установки, такие как контроль источников питания, блок управления, блокировок и сигнализаций (УБС), часть прикатодной электроники и блока фокусировки и отклонения пучка и другие, не требуют быстрого управления, то есть частота подачи сигналов и время реакции на события может принимать значение порядка нескольких секунд, с чем успешно справляется персональный компьютер. Такие подсистемы мы называем медленными.
\subsubsection{Быстрые подсистемы}
Однако для проведения некоторых экспериментов на установке появилась необходимость в достаточно быстром и точном управлении интенсивностью электронного пучка, магнитной оптикой или перемещении объектов в вакуумной камере. Эти системы мы теперь называем быстрыми.
\newline
Контроль пучка состоит из управления параметрами источника пучка (такими как ток пучка, напряжение на обкладках и т.д.) и магнитной оптикой (фокусировка и отклонение пучка). Контроль данных подсистем осуществляется с помощью аналого-цифрового контроллера CAC208, общение с которым осуществляется по шине CAN. Данное устройство работает с частотой дискретизации 100 Гц.
\newline
Работа "Применение Xenomai для управления технологическим процессом электронно-лучевой сварки" \cite{xeno_weld} была посвящена управлению магнитной оптикой на данной установке в режиме реального времени. Однако после монтажа альфа-магнита на установку, возможный угол отклонения пучка с помощью магнитных линз значительно уменьшился с нескольких десятков сантиметров до единиц, поэтому возникла потребность в механических подвижках, на которых закреплялся бы объект и перемещался бы внутри рабочего объёма. Возникла задача конструирования данных подвижек и разработки системы управления для них.

\section{Постановка задачи}
\subsection{Цель работы}
В рамках данной работы была поставлена задача разработать и собрать программно-аппаратную систему управления для быстрых компонентов малой электронно-лучевой установки ИЯФ СО РАН, удовлетворяющую поставленным требованиям, которые описаны далее.

\subsection{Требования к системе управления}
К системе управления был предъявлен список требований, часть которых обусловлена свойствами техпроцесса, часть - экспериментальным характером установки.
\subsubsection{Основные требования}
Система управления должна обеспечивать позиционирование и перемещение механических подвижек по трём осям с обратной связью в виде концевиков (датчиков приближения подвижки к краям оси) внутри электронно-лучевой установки. Желательно, чтобы перемещение осуществлялось по достаточно сложным траекториям, задаваемым пользователем. Также системе управления необходимо уметь работать с CAN-оборудованием на установке. Система управления должна иметь пользовательский интерфейс.
\subsubsection{Быстродействие}
Техпроцесс электронно-лучевых технологий предъявляет следующие требования:
\begin{itemize}
    \item скорость перемещения подвижек - не менее 10 мм/c;
    \item точность позиционирования - порядка минимальной ширины электронного пучка, равной 0.1 мм;
    \item cинхронизация между каналами - должна удовлетворять предыдущему требованию, то есть не должна вносить ошибку больше ширины пучка - 0.1 мм;
    \item периодичность CAN-посылок - не реже, чем каждые 10 мс.
\end{itemize}
\subsubsection{Гибкость и простота разработки}
Так как малая электронно-лучевая установка в ИЯФ является экспериментальной, то есть на ней проверяются новые технические решения и методы техпроцесса, то желательно чтобы система управления была как можно более многофункциональной и универсальной, и при этом простой в разработке и внесении дальнейших модификаций.

\section{Решение задачи}
\subsection{Возможные решения}
Были рассмотрены следующие варианты:
\begin{itemize}
    \item обыкновенный персональный компьютер:
    \begin{itemize}
        \item под управлением стандартной ОС;
        \item под управлением специализированной операционной системы реального времени;
    \end{itemize}
    \item одноплатный микрокомпьютер:
    \begin{itemize}
        \item NI MyRIO\cite{myrio};
        \item Raspberry Pi\cite{raspberry_pi}:
        \begin{itemize}
            \item под управлением стандартной ОС;
            \item под управлением ОС реального времени;
        \end{itemize}
    \end{itemize}
    \item микроконтроллер;
    \item ПЛИС.
\end{itemize}
Рассмотрим каждый из этих вариантов.
\newline
Современные персональные компьютеры с процессором архитектуры x86-64 обладают хорошей производительностью, однако обычно не оборудованы низкоуровневыми аппаратным интерфейсами, которые требуются для работы с оборудованием установки. Это может быть исправлено установкой аппаратных модулей, но они вносят дополнительную сложность. Персональные компьютеры предназначены для работы под управлением операционных систем общего назначения, таких как Linux, Windows и т.д. Эти операционные системы в среднем обладают небольшим временем отклика, однако в редких случаях могут возникать значительные задержки.
\newline
Чтобы избежать этих задержек используются операционные системы жёсткого реального времени. Такие системы гораздо менее функциональные, и, что значительно хуже, с ними совсем не совместимо программное обеспечение, написанное для ОС Linux, используемое в ИЯФ. Однако существует фреймворк для разработки и запуска приложений, называемый Xenomai\cite{xenomai}, который внедряет в ядро Linux небольшую систему реального времени, и позволяет запускать программы для Linux, с небольшими изменениями, в режиме реального времени. Работа "Применение Xenomai для управления технологическим процессом электронно-лучевой сварки" \cite{xeno_weld} была посвящена исследованию и применению Xenomai для этой же электронно-лучевой установки. Однако с Xenomai возникают некоторые трудности. Одна из них - отсутствие драйверов реального времени для большинства устройств. Так как ядро реального времени Xenomai сильно отличается от ядра Linux, требуется разрабатывать отдельные драйвера для необходимых устройств, что является очень трудоёмкой задачей. Другая проблема заключается в том, что архитектура современных ПК не предназначена для жёсткого реального времени, поэтому, например, в случае использования дискретного графического процессора, могут возникать непредвиденные задержки и при использовании ядра Xenomai.
\newline
Другой вариант - использовать компьютеры с другой архитектурой, например, одноплатные компьютеры. Был рассмотрен вариант компьютера National Instruments MyRIO\cite{myrio}. Он имеет необходимые нам аппаратные интерфейсы, а также, что очень хорошо, работает на базе чипа Xilinx Zinq, который имеет помимо процессора ARM ещё и FPGA (ПЛИС) на борту. Однако основными проблемами данной платформы является её закрытость, использование собственного программного интерфейса и средств разработки, что делает очень сложной задачу переноса используемого в ИЯФ программного обеспечения на данную платформу. Также можно отметить высокую стоимость данного решения.
\newline
Другой одноплатный компьютер, рассмотренный нами - Raspberry Pi\cite{raspberry_pi}. В отличие от предыдущей платформы, Raspberry Pi является открытой, использует свободную операционную систему Debian Linux, очень много готовых программ и библиотек с открытой документацией, стандартный для Linux программный интерфейс, и огромное сообщество разработчиков. Raspberry Pi может использоваться в качестве компьютера общего назначения. Данный компьютер, также, как и MyRIO, имеет много низкоуровневых аппаратных интерфейсов. Также можно отметить высокую доступность данного компьютера и большое количество различных плат расширения для него.
\newline
Также была исследована возможность использования Xenomai для Raspberry Pi, было собрано ядро Linux для Raspberry Pi с Xenomai, однако оказалось, что Xenomai ещё не умеет должным образом работать с периферией Raspberry Pi вследствие чего возникают различные ошибки, плюс остаётся проблема с драйверами для Xenomai.
\newline
Были рассмотрены варианты использования микроконтроллеров и ПЛИС (Программируемые Логические Интегральные Схемы). Данные устройства обеспечивают очень высокое быстродействие в режиме жёсткого реального времени. Однако разработка, отладка и внесение модификаций программы для данных устройств имеет высокую сложность.
\newline
Из всех вышеперечисленных вариантов была выбрана платформа Raspberry Pi, как удовлетворяющая всем требованиям к системе управления и наиболее удобная для разработки и использования программного обеспечения.

\subsection{Raspberry Pi}
\subsubsection{Обзор платформы}
Raspberry Pi - это полноценный одноплатный компьютер. Внешний вид этого компьютера изображён на рис. \ref{fig:rpi_front} и \ref{fig:rpi_back}. Существуют несколько версий и моделей данной платформы, но нас интересуют версии 2 и 3, которые являются наиболее производительными и близки друг к другу по функционалу.
\newline

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/rpi_layout_front.jpg}}
    \caption{Одноплатный компьютер Raspberry Pi 3, вид сверху}
    \label{fig:rpi_front}
\end{figure}

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/rpi_layout_back.jpg}}
    \caption{Одноплатный компьютер Raspberry Pi 3, вид снизу}
    \label{fig:rpi_back}
\end{figure}

Компьютер работает на базе процессора архитектуры ARM\cite{arm}. Версии 2 и 3 имеют на борту 1 ГБ оперативной памяти LPDDR2.
Операционная система загружается с MicroSD флеш-накопителя, для которого имеется разъём на плате, и в дальнейшем работает с файловой системой на этом накопителе.
\newline
Для питания требуется источник питания напряжением 5 В, обеспечивающий ток до 2.5 А. Питание подключается либо ко входу MicroUSB на плате, либо к GPIO, однако имеется информация, что второй вариант нежелателен, так как не оборудован защитами, как первый\cite{raspberry_pi_power}.
\newline
Raspberry Pi может использоваться как полноценный персональный компьютер, либо как встраиваемое устройство.

\subsubsection{CPU и SoC}
Raspberry Pi - это система на кристалле (System on Chip, SoC) - то есть на основном чипе находится не только центральный процессор (Central Processing Unit, CPU), но и другие подсистемы платформы. 
Версия 2 использует чип Broadcom BCM2836, работающий на базе 64-битного процессора ARM\cite{arm} Cortex-A7 (система команд ARMv7-A), имеющего 4 процессорных ядра и работающего на частоте 900 МГц.
Версия 3 - чип BCM2837 с также 64-битным процессором ARM Cortex-A53 (ARMv8-A) - 4 ядра, 1.2 ГГц. Помимо центрального процессора на кристалле расположен  графический процессор (Graphics Processing Unit, GPU) - VideoCore IV, работающий на частоте 250 МГц в версии 2 и 400 МГц в версии 3 и также имеющий доступ к оперативной памяти. Архитектура системы на кристалле\cite{raspberry_pi_peripherals} у всех версий Raspberry Pi практически совпадает, и помимо центрального и графического процессора включает в себя:
\begin{itemize}
    \item таймеры;
    \item контроллер прерываний;
    \item GPIO (Ввод-вывод общего назначения);
    \item USB;
    \item PCM / I2S;
    \item контроллеры DMA;
    \item I2C master + I2C slave;
    \item 3 SPI + 1 SPI slave;
    \item PWM (ШИМ);
    \item 2 UART.
\end{itemize}
Также имеется ряд модулей, используемых графическим процессором, однако не рекомендуется работать с ними через центральный процессор.
Все периферийные устройства, а также центральный и графический процессор имеют доступ к общей шине, и взаимодействуют друг с другом через неё. Шина представлена как адресное пространство. Иерархия адресных пространств Raspberry Pi изображена на рис. \ref{fig:rpi_mem}.

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/rpi_mem.png}}
    \caption{Структура адресных пространств компьютера Raspberry Pi}
    \label{fig:rpi_mem}
\end{figure}

Программы на Raspberry Pi работают с виртуальным адресным пространством, на которое отображено физическое адресное пространство с помощью ARM MMU (Memory Management Unit - менеджер памяти). На физическое адресное пространство отображается адресное пространство шины посредством ARM MMU и VideoCore MMU. На адресное пространство шины отображаются периферийные устройства, а также оперативная память (SDRAM). Адресное пространство шины поделено на четыре одинаковых области, которые отличаются только двумя старшими битами, которые определяют способ кэширования при записи в эту память. Работа с оборудованием осуществляется посредством записи и чтения из области адресов, принадлежащих шине.
Raspberry Pi версии 2 и 3 имеют следующие внешние интерфейсы:
\begin{itemize}
    \item 4 USB 2.0;
    \item 40 GPIO контактов;
    \item Ethernet 10/100 Mbps;
    \item HDMI;
    \item 3.5 мм аудиовыход (совмещённый с композитным видеовыходом);
    \item последовательные интерфейсы камеры (CSI) и дисплея (DSI).
\end{itemize}
Версия 3 имеет дополнительно:
\begin{itemize}
    \item 802.11n Wireless LAN;
    \item Bluetooth 4.0.
\end{itemize}

\subsubsection{Операционная система}
Для Raspberry Pi доступен набор операционных систем начиная от различных версий и дистрибутивов Linux и заканчивая Windows 10 IoT Core. Для нашей системы управления был выбран Raspbian\cite{raspbian} - порт дистрибутива Debian Linux специально для Raspberry Pi с поддержкой математического сопроцессора (архитектура armhf - ARM hardware float). Этот выбор был сделан по причине того, что Linux - современная открытая операционная система, лучше всего подходящая для разработки и исполнения программ, а Raspbian является основной сборкой Linux для Raspberry Pi с наилучшей поддержкой и содержит на данный момент 35 000 из более чем 50 000 доступных пакетов Debian, портированных под Raspberry Pi.

\subsubsection{Разработка приложений}
Существует два способа разработок приложений для Raspberry Pi - прямой и кросс-компиляция. Кросс-компиляция - способ, когда приложение разрабатывается и собирается на другой машине, часто с другой архитектурой, на которую устанавливается набор библиотек и компиляторов для целевой архитектуры, и только уже собранная программа загружается на нужную машину. Второй способ - когда разработка и сборка происходит непосредственно на целевой машине и для неё. В нашем случае для сборки программной части системы управления мы использовали прямой способ, так как он гораздо более простой и удобный, наша система управления имеет достаточно небольшой объём программного кода, а Raspberry Pi является полноценным компьютером, подходящим в том числе и для таких задач. Однако, для сборки более объёмных программных компонент, например, для сборки Linux, нам приходилось использовать кросс-компиляцию, так как процессоры ARM на данный момент всё ещё уступают по производительности процессорам настольных компьютеров архитектуры x86-64.

\subsection{Система управления}
Разработка системы управления состояла из двух частей: аппаратной и программной.
\subsubsection{Аппаратная часть}
Разработка аппаратной части включала в себя выбор и изучение оборудования для управления системами установки, организация и настройка связи между этим оборудованием и компьютером Raspberry Pi, а также размещение всего этого в стандартном конструктиве.

\subsubsubsection{Управление шаговыми двигателями}
Система подвижек оборудована тремя (по одному на каждую ось) шаговыми двигателями FL42STH производства НПФ Электропривод \cite{stepper}. Внешний вид двигателя приведён на рис. \ref{fig:stepper}.
\newline
Шаговые двигатели в рассматриваемой установке управляются по протоколу 'step-dir' через трёхканальный драйвер шаговых двигателей SMD-303 производства НПФ Электропривод \cite{stepper_driver} (изображён на рис. \ref{fig:stepper_driver}).
\newline

\begin{figure}[h!]
    \centerline{\includegraphics[width=300pt]{media/fl42sth.jpg}}
    \caption{Внешний вид шагового двигателя FL42STH}
    \label{fig:stepper}
\end{figure}

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/smd-303.jpg}}
    \caption{Внешний вид драйвера шаговых двигателей SMD-303}
    \label{fig:stepper_driver}
\end{figure}

На каждый двигатель на драйвере приходится по три цифровых входа: 'step', 'dir'  и 'enable'. Вход 'dir' отвечает за направление вращения двигателя: когда на него подаётся логический ноль - двигатель вращается против часовой стрелки, а когда единица - по часовой стрелке. Когда на вход 'step' подаётся импульс - двигатель делает один шаг. Вход 'enable' включает или отключает ток через обмотки двигателя. Когда двигатель стоит, этот вход включает или отключает режим удержания. Сигналы на данные входы подаются напрямую с GPIO Raspberry Pi.
\newline
В нашей системе используется довольно простой механизм перемещения шагового двигателя, характеризующийся тремя параметрами: начальной скоростью, максимальной скоростью и максимальным ускорением. Начальная скорость - это такая скорость, с которой двигатель может начать двигаться из состояния покоя сразу, без разгона. Максимальная скорость - наибольшая скорость, до которой двигатель может стабильно разогнаться. Максимальное ускорение - наибольшее ускорение, с которым двигатель может разгоняться. Механизм передвижения таков: двигатель стартует с начальной скорости, разгоняется с постоянным максимальным ускорением до максимальной скорости, движется с этой скоростью почти до нужного положения, после чего с таким же ускорением тормозит до начальной скорости и останавливается. На стадию разгона и торможения приходится фиксированное число шагов, остальные шаги двигатель проходит с постоянной скоростью. Если нужно сделать меньше шагов, чем требуется для разгона и торможения в сумме, то первую половину пути двигатель разгоняется с максимальным ускорением, не достигая максимальной скорости, вторую половину пути тормозит с таким же ускорением.
Примерный график скорости при данном механизме движении приведён на рис. \ref{fig:stepper_move}.

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/stepper_move.pdf}}
    \caption{Характерный график зависимости скорости от времени при перемещении подвижки. $v$ - скорость двигателя, $t$ - время, $v_{ini}$ - начальная скорость, $v_{max}$ - максимальная скорость, $a_{max}$ - максимальное ускорение двигателя.}
    \label{fig:stepper_move}
\end{figure}

Все возможные виды движения двигателей в нашей системе реализуются только через протокол step-dir, то есть последовательностью импульсов с плавно меняющейся частотой.
$$Formulae$$
Точность позиционирования подвижек обусловлена в первую очередь точным подсчётом выдаваемых импульсов, а также правильно подобранными параметрами движения, при которых шаги не пропускаются двигателем.

\subsubsubsection{Получение сигнала с сенсоров}

Каждая ось подвижек оборудована двумя бесконтактными индукционными сенсорами близости модели Panasonic GX-F12A-P. Когда подвижка оказывается на уровне сенсора, металлическая пластинка на подвижке приближается к нему на расстояние в несколько миллиметров, и сенсор срабатывает. Схема сенсора, а также внешний вид и размещение на подвижках изображены на рис. \ref{fig:sensor_circuit}, \ref{fig:sensor_mounted}. 

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/sensor-circuit.pdf}}
    \caption{Схема сенсора Panasonic GX-F12A-P и механизм подключения.}
    \label{fig:sensor_circuit}
\end{figure}

\begin{figure}[h!]
    \centerline{\includegraphics[width=200pt]{media/sensor_mounted.jpg}}
    \caption{Внешний вид сенсора Panasonic GX-F12A-P, смонтированного на ось подвижки.}
    \label{fig:sensor_mounted}
\end{figure}

Так как сенсоры используются непосредственно в вакуумной камере и подвержены значительным наводкам от электронного пучка, а также работают на напряжении, значительно большем 3.3В, использующихся в логике GPIO, поэтому был разработан и собран адаптер для концевиков с оптической развязкой. Внешний вид и схема приведена на рис. \ref{fig:adapter} и [fig:adapter-circuit].

\begin{figure}[h!]
    \centerline{\includegraphics[width=300pt]{media/adapter.jpg}}
    \caption{Внешний вид разработанного нами адаптера концевиков с оптической развязкой.}
    \label{fig:adapter}
\end{figure}

[TODO: Схема адаптера [adapter-circuit]]

Механизм работы адаптера следующий: когда оптопара закрыта, на входе GPIO - логический ноль. Когда концевик активирован, фотодиод в оптопаре открывается, напряжение на входе GPIO становится +3.3В - то есть логическая единица для GPIO.

\subsubsubsection{Подбор параметров движения}
Был разработан и реализован механизм подбора параметров перемещения подвижки, близких к оптимальным. Проверка параметров работает следующим образом: подвижка перемещается на достаточное расстояние от концевика, после чего движется с новыми параметрами обратно к нему. Если параметры превысили допустимые значения, то подвижка пропустит шаги, остановится и не сможет доехать до концевика. Сперва подбирается начальная скорость. Подбор начинается с некоторой безопасной скорости, с которой двигатель точно сможет ехать. Потом эта скорость последовательно удваивается и проверяется вышеуказанным методом, пока на каком-либо шаге проверка окажется неудачной - то есть начальная скорость превысит допустимое значение. После этого между неудачным и последним удачным значением параметра выполняется несколько шагов двоичного поиска с таким же методом проверки. В результате мы получаем близкое к оптимальному значение скорости и для большей надёжности уменьшаем его на 25\%. После подбора начальной скорости нужно подобрать максимальную скорость и максимальное ускорение. Это сделать сложнее, так как эти параметры зависят друг от друга. Примерный вид зависимости был определён экспериментально и изображён на рис. \ref{fig:stepper_velacc}.
\newline

\begin{figure}[h!]
    \centerline{\includegraphics[width=400pt]{media/stepper_velacc.pdf}}
    \caption{Характерный график зависимости максимальной скорости шагового двигателя от ускорения. $v$ и $a$ - скорость и ускорение двигателя в какой либо момент времени, $v_{max | a=0}$ и $v_{max | a=a_{max}}$ - максимальная скорость при условии, что ускорение равно 0 и найденному нами близкому к оптимальному ускорению соответственно.}
    \label{fig:stepper_velacc}
\end{figure}

Был предложен следующий метод поиска данных параметров: берутся некоторые безопасные значения данных параметров. Сначала фиксируется ускорение и выполняется двоичный поиск максимальной скорости также, как и для начальной скорости. Найденное значение запоминается. После этого максимальное ускорение удваивается, снова фиксируется, и снова повторяется поиск максимальной скорости как и на предыдущем шаге, но уже для нового значения ускорения. Попытка подбора некоторого значения ускорения считается удачной, если значение максимальной скорости для этого ускорения не меньше, чем 95\% от максимальной скорости для начального ускорения. Таким образом выполняем также двоичный поиск для значения ускорения, и в результате мы должны получить значение максимального ускорения и соответствующее ему значение скорости не меньше, чем 95\% от максимальной скорости двигателя при начальном ускорении. Данный метод удобен потому, что он почти не требует контроля со стороны человека - только указание начальных безопасных значений параметров. Также он позволяет автоматизированно пересчитывать параметры в случае изменения нагрузки на подвижки или при изменении их конфигурации.

\newpage

\begin{thebibliography}{99}

\bibitem{weld_coord}
Купер Э.А., Логачев П.В., Репков В.В., Селиванов А.Н., Селиванов П.А., Семенов Ю.И., Трибендис А.Г., Федотов М.Г., Чертовских А.С. -
Автоматизированная система для задания координат шва в установках электронно-лучевой сварки. –
Автометрия. Издательство СО РАН. Новосибирск. – 2015. – Том 51, №1. – С. 55 – 61.

\bibitem{wolfram_3d}
Семенов Юрий Игнатьевич, Алякринский О.Н., Болховитянов Д.Ю., Логачев П.В., Медведев А.М., Спесивцев А.Б., Старостенко А.А., Яминов К.Р. -
Макет 3D принтера для изготовления металлических структур из тугоплавких металлов с помощью электронно-лучевых аддитивных технологий. -
Институт ядерной физики им. Г.И. Будкера СО РАН (Новосибирск), Россия. -
\url{http://conf.ict.nsc.ru/clapt2015/ru/program}

\bibitem{alpha_magnet}
О.Н. Алякринский, М.А. Батазова, Д.Ю. Болховитянов, М.Ю. Косачев, П.В. Логачев, А.М. Медведев, Ю.И. Семенов, М.М. Сизов, А.А. Старостенко, А.С. Цыганов. Прототип источника электронов с магнитным поворотом пучка для электронно-лучевых технологий.

\bibitem{laser_heat}
О.Н. Алякринский, К.В. Губин, М.Ю. Косачев, Э.А. Купер, П.В. Логачев, А.М. Медведев, В.К. Овчар, В.В. Репков, Ю.И. Семенов, М.М. Сизов, А.А. Старостенко, М.Г. Федотов, А.С. Цыганов. Прототип источника пучка электронов с лазерным подогревом катода.

\bibitem{facility_desc}
Энергоблок для установки электронно-лучевой сварки с внутрикамерной электронно-оптической колонной – Краткое описание и инструкция по эксплуатации – \url{https://drive.google.com/open?id=1JrrE1etLfC301fcXQOi6f3ODAfCXQ4m_zBib-fV6Bjk}

\bibitem{xeno_weld}
Герасёв А. В. -
Применение Xenomai для управления технологическим процессом электронно-лучевой сварки : выпускная квалификационная работа бакалавра -
Научный руководитель: Чеблаков П. Б. -
Новосибирск, 2016.

\bibitem{can}
Texas Instruments –
Introduction to Controller Area Network (CAN) –
\url{http://www.ti.com/lit/an/sloa101a/sloa101a.pdf}

\bibitem{kozak_cac208}
Козак Виктор Романович -
Прецизионный аналого-цифровой контроллер CAC208 -
22 мая 2014 г. -
\url{http://www.inp.nsk.su/~kozak/designs/cac208.htm}

\bibitem{myrio}
National Instruments -
MyRIO - учебное устройство для проектирования встраиваемых систем -
\url{http://www.ni.com/ru-ru/shop/engineering-education/portable-student-devices/myrio-student-embedded-device/what-is-myrio.html}

\bibitem{raspberry_pi}
Raspberry Pi - Official Website -
\url{https://www.raspberrypi.org/}

\bibitem{raspbian}
Raspbian -
Операционная система для Raspberry Pi, основанная на базе Debian Linux -
\url{https://www.raspbian.org/}

\bibitem{raspberry_pi_power}
Raspberry Pi Stack Exchange -
How do I supply power through the GPIO? -
\url{https://raspberrypi.stackexchange.com/questions/1617/how-do-i-supply-power-through-the-gpio/1618#1618}

\bibitem{raspberry_pi_peripherals}
Broadcom -
BCM2835 ARM Peripherals -
документация по периферии чипов, использующихся в компьютере Raspberry Pi -
\url{https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf}

\bibitem{arm}
ARM Processors -
Official Website -
\url{https://www.arm.com/products/processors}

\bibitem{xenomai}
Xenomai – Real-time framework for Linux –
Official Website -
\url{https://xenomai.org/}

\bibitem{stepper}
НПФ "Электропривод" -
Гибридные шаговые двигатели серии FL42STH -
документация -
\url{http://electroprivod.ru/fl42sth.htm}

\bibitem{stepper_driver}
НПФ "Электропривод" -
Блок управления шаговыми двигателями SMD-303 -
документация -
\url{http://electroprivod.ru/smd-303.htm}

\bibitem{cx}
Болховитянов Д. Ю. –
Программное обеспечение системы управления инжекционного комплекса ВЭПП-5 :
автореферат дис. ... кандидата технических наук :
01.04.01 [Место защиты: Ин-т ядерной физики им. Г.И. Будкера, 2007] -
\url{http://www.inp.nsk.su/news/defences/bolkhovityanov-autoref.pdf}

\end{thebibliography}

\newpage

\section{Приложения}

\end{document}
